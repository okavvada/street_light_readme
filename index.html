<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Street Light Project by okavvada</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">


  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Street Light Project</h1>
        <p class="header"></p>

        <p class="header">Spatial Analysis</p>

      </header>
      <section>

        <h3>
<c class="anchor" aria-hidden="true"></c>Original Data</h3>
<p><u>Open Data: </u>
<ul>Road geometries: troncon voie</ul>
<ul>Street lights: eclairage public</ul>

<u>Street Light Data: </u>
<ul>MS Access Database: MuseEvesa_ExportVDP_Engie_v8.mdb</ul>
<ul>geometry: SPATIALPOINT</ul>

<u>Measurement Data: </u>
<ul>xls files: Campagne 2018 Paris</ul>
<ul>raw measurement data: brute</ul>
<ul>analysis data: analyse</ul></p>


<h3><c class="anchor" aria-hidden="true"></c>Road Geometric Calculations</h3>
<pre class="hljs"><code><div><span class="hljs-comment">Add Road Widths to road geometries</span>
<p>In order to calculate the road and sidewalk widths, we use the polygon features for roadways and sidewalks, sourced by the City of Paris open data. </p>
<p>- First we calculate the area of all the polygons (roads and sidewalks) in square meters.
- Then we approximate the length of each polygon by calculating the longest line. 
- The width of the polygon is then identified by dividing the area with the length. </p>
<p>The next step is to connect the roads ids, with the polygon features in order to get a 1-to-1 connection between all polygons to a road segment. That will help us connect the calculated widths to a the street line geometry.</p>
<p>- First we convert the roads line geometry to a centroid so we can match the polygons.
- For each polygon we then identify the closest centroid and match it to it. As an optimization for faster spatial operations we only search for the closest point inside a buffer zone of 100m
- We create look up tables with road ids and road polygon and sidewalk ids for each. As one road can have multiple sidewalks the lookup table can have multiple sidewalk ids for the same road id
- We join the polygon tables with the road id using the lookup tables and assign an area and a width to each road segment. If there are multiple sidewalks assigned to a road segment, the sum of the width and area are added.</p>


<h3>
<c class="anchor" aria-hidden="true"></c>Lighting Infrastructure</h3>

<pre class="hljs"><code><div><span class="hljs-comment">Connecting lights to road segments</span>
<p>Fistly, some preprocessing was done to convert the point geometries to WGS 84 and delete some geometries that were not assigned with the correct SRID and could not be projected.
All relevant tables from the MS access database were then joined into one using the IDs provided and explained in the Metadata.xls file. This data was stored in a new table called "all_mdb_data".</p>
<p>The data was filtered to only include lighting features and this new data was stored in a new table called "street_lights_only" by "MTYLIBELLE" = 'Lampe EP'.
Then the street light geometries where connected with the open data street light geometries by distance. For optimization reasons only the lights that were in close proximity (within 10 m of each other) were assessed when looking for the closest one. To avoid duplicate lights being assigned to a single point, all street lights were only allowed to have one connection with a different point. The lookup table with the codes for the connection was stored in a new table called "open_mdb_lights_codes".</p>
<p>Using the lookup table the street lights were connected to the open data street lights and their properties shared. The joined tables were stored as a new table "open_mdb_lights".
We then connect the street lights to the road segments by distance to create a lookup table between the road names as present in the street light table (VOILIBELLE) and the road id. Each light is connected to one road and then the road id is assigned the most popular name from all street lights connected to it. That is done to avoid wrong naming streets as some lights on corners are assigned to them but technically belong to a different street.</p>
<p>Then each street light is assigned to a road segment by distance. As mentioned before some street lights on corners might be closer to a different segment. To avoid mismatching only the roads that have the same name as the one mentioned in the street lights table as assessed when looking for the closest segment.
Finally, for each road segment the lights that were matched to it are counted and added as a separate column in the streets table "stlights_number".</p>


<h3>
<c class="anchor" aria-hidden="true"></c>Lighting Measurements</h3>

<pre class="hljs"><code><div><span class="hljs-comment">Connecting measurements to road segments</span>
<p>The light measurements are sourced from the xls files from the client. The xls files are combined into one file before they are uploaded to Postgres. The "brute" file is the raw measurements and the "analyse" file is the analyses for each road segment. We will use the brute file to connect the road names to the road segment ids, and the analyse file to assign the result of the street light measurements to each road segment.</p>
<p>- First we generate a new column for both the brute and analyse files that will concatenate the CONTRAT, VOIE and TRONCON into one field, so each road segment has a unique identifier and re-upload to the database.
- Similar as before we connect each measurement to its closest road segment by distance. We group by all the road segments, and each gets the most popular name out of all the measurement points that were connected to it. That is to avoid mismatches in street corners, where the measurement might be closer to a different road segment. The result is added to a lookup table named "roadName_rid_codes".
- We can also add the data from the lookup table that was generated before that includes the road names from the street light data ("roadName_fromlights_rid").
- Finally, we join the analyse table with the road segment geometries using the lookup table that was just generated.</p></p>

<h3>
<c class="anchor" aria-hidden="true"></c>Support or Contact</h3>

<p>Do you have questions or comments? Please contact Olga Kavvada: <a href="https://github.com/okavvada">@okavvada</a> or email <a class="email" href="mailto:okavvada@gmail.com">okavvada@gmail.com</a>.</p>
      </section>
      <footer>
        <p><small>This project is maintained by <a href="https://github.com/okavvada">@okavvada</a></p>
        <p><small>See other <a href="https://okavvada.github.io/">blogs</a></p>
      </footer>
    </div>
		
  </body>
</html>

